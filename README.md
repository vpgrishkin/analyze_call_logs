# README

## Задача
Есть лог звонков call-центра. В нем зафиксировано время начала и конца звонка.
Количество записей в логе может быть очень большим.

Нужно написать эффективный по использованию памяти набор скриптов, который сможет определить минимальное количестов операторов call-центра, чтобы ни один звонок не ожидал оператора.

### Пример лога
```
FROM:2021-01-30 22:18 TO:2021-01-30 22:31
FROM:2021-02-04 00:46 TO:2021-02-04 00:53
FROM:2021-01-29 18:46 TO:2021-01-29 19:02
FROM:2021-02-02 17:02 TO:2021-02-02 17:09
FROM:2021-01-30 15:44 TO:2021-01-30 16:05
FROM:2021-02-05 11:58 TO:2021-02-05 12:14
FROM:2021-02-01 00:29 TO:2021-02-01 00:45
FROM:2021-01-31 02:59 TO:2021-01-31 03:11
FROM:2021-02-02 15:06 TO:2021-02-02 15:17
FROM:2021-01-28 20:58 TO:2021-01-28 21:26
FROM:2021-02-03 23:29 TO:2021-02-03 23:48
FROM:2021-02-06 13:55 TO:2021-02-06 14:19
FROM:2021-01-31 04:41 TO:2021-01-31 04:53
FROM:2021-02-01 18:45 TO:2021-02-01 19:00
FROM:2021-01-28 13:29 TO:2021-01-28 13:49
```

### Генерировать лог можно так
```
import time
import random

for _ in range(15):
    avg = time.time() - random.random() * 1_000_000
    delta_fr = random.random() * 1000
    delta_to = random.random() * 1000

    fr = time.strftime("%Y-%m-%d %H:%M", time.localtime(avg - delta_fr))
    to = time.strftime("%Y-%m-%d %H:%M", time.localtime(avg + delta_to))
    
    print(f"FROM:{fr} TO:{to}")
```
или используя скрипт для генерации фикстур ./fixtures/fixtures.py

## В проекте представлены два скрипта:

1. **split_log_by_days.py** — скрипт для пакетной обработки очень большого лог-файла с разбиением записей по дням.
2. **analyze_call_center_load.py** — скрипт для анализа разбиенных логов и определения минимального количества операторов для call-центра.

---

# Скрипт split_log_by_days.py

## Назначение

Скрипт предназначен для пакетной (batch by batch) обработки **очень большого лог-файла**, который не помещается в ОЗУ, с разбиением записей по дням. Если запись пересекает полночь (`00:00`), она автоматически разбивается на две записи. Каждая дата сохраняется в отдельный файл формата `YYYY-MM-DD.log`. При прерывании (Ctrl+C) обработает оставшуюся часть и выведет финальную позицию.

## Как использовать

1. **Подготовьте файл лога**
   
   Убедитесь, что у вас есть файл с записями такого вида:

   ```
   FROM:2021-01-30 22:18 TO:2021-01-30 22:31
   FROM:2021-02-04 00:46 TO:2021-02-04 00:53
   ```

2. **Настройте параметры в скрипте**

   В начале скрипта задаются основные параметры:

   ```python
   LOG_FILE = 'big_log.txt'      # Имя файла
   BATCH_SIZE = 1000             # Размер одной пачки строк
   OUTPUT_DIR = 'logs_by_day'    # Директория для выходных файлов
   START_POSITION = 0            # Позиция для старта чтения
   ```

3. **Запустите скрипт**

   ```bash
   python3 split_log_by_days.py
   ```

## Пример структуры выходных файлов

После работы скрипта в директории `logs_by_day/` появятся файлы:

```
logs_by_day/
├── 2021-01-28.log
├── 2021-01-29.log
├── 2021-01-30.log
...
```

Каждый файл будет содержать записи только за соответствующую дату.

## Дополнительно

**Важно:** для работы требуется Linux/Unix-система, так как используется модуль `fcntl` для блокировки файлов.

---

# Скрипт analyze_call_center_load.py

## Назначение

`analyze_call_center_load.py` — это скрипт для анализа логов звонков call-центра. Он определяет минимальное количество операторов, необходимое для обработки всех звонков без ожидания.

Особенности:
- Поддержка обработки большого количества файлов.
- Эффективный подсчёт с использованием кучи (`heapq`).
- Многопроцессорная обработка (`multiprocessing.Pool`).
- Цветной графический интерфейс в терминале (TUI).
- Проверка блокировок файлов через `fcntl`.

## Требования

- Python 3.8+
- Установить зависимость:

```bash
pip install -r requirements.txt
```

## Структура данных

Скрипт ожидает файлы логов формата:

```
FROM:2021-01-30 22:18 TO:2021-01-30 22:31
FROM:2021-01-30 23:50 TO:2021-01-31 00:05
...
```

Файлы (пример fixtures/logs_by_day/) должны находиться в директории `logs_by_day/`.

## Как использовать

1. **Подготовьте файлы логов**
   - Файлы должны быть названы в формате `YYYY-MM-DD.log` (например, `2021-01-30.log`).
   - Все файлы положите в папку `logs_by_day/`.

2. **Запустите скрипт**

```bash
python analyze_call_center_load.py
```

3. **Выберите количество процессов**

Скрипт предложит ввести количество процессов для ускорения обработки (по умолчанию — 4).

4. **Просмотрите результаты**

- После обработки выводится:
  - Минимальное количество операторов.
  - Время звонков в пиковую нагрузку (количество выводимых записей ограничено константой MAX_EXAMPLES).


## Ограничения
- Скрипты рассчитаны на работу в Linux/Unix среде (используется `fcntl` для блокировки файлов).
- Windows не поддерживает `fcntl`.
